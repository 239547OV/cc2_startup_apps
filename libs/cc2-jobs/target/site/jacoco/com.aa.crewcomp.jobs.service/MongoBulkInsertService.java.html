<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MongoBulkInsertService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cc2-jobs</a> &gt; <a href="index.source.html" class="el_package">com.aa.crewcomp.jobs.service</a> &gt; <span class="el_source">MongoBulkInsertService.java</span></div><h1>MongoBulkInsertService.java</h1><pre class="source lang-java linenums">package com.aa.crewcomp.jobs.service;

import org.bson.types.ObjectId;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.mongodb.BulkOperationException;
import org.springframework.data.mongodb.core.BulkOperations;
import org.springframework.data.mongodb.core.MongoTemplate;
import com.aa.crewcomp.jobs.interfaces.Cc2JobRepositoryInterface;
import com.mongodb.bulk.BulkWriteError;
import com.mongodb.bulk.BulkWriteResult;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.ArrayList;
import java.util.Date;

public class MongoBulkInsertService&lt;EntityClassType&gt; {
<span class="fc" id="L20">    private static final Logger logger = LoggerFactory.getLogger(MongoBulkInsertService.class);</span>
    private final Class&lt;EntityClassType&gt; entityClassType;
    @Autowired
    private MongoTemplate outputMongoTemplate;

    @Autowired
    private Cc2JobRepositoryInterface cc2JobRepository;

<span class="fc" id="L28">    public final int CHUNK_SIZE = 5000;</span>
    private List&lt;EntityClassType&gt; buffer;
<span class="fc" id="L30">    private long minBulkAliveDurationMillis = 10000L;</span>
<span class="fc" id="L31">    private long bulkStartMillis = new Date().getTime();</span>

<span class="fc" id="L33">    public MongoBulkInsertService(Class&lt;EntityClassType&gt; entityClassType) {</span>
<span class="fc" id="L34">        this.entityClassType = entityClassType;</span>
<span class="fc" id="L35">        this.buffer = new ArrayList&lt;EntityClassType&gt;();</span>
<span class="fc" id="L36">    }</span>

    public void save(ObjectId jobId, EntityClassType input) {
<span class="fc bfc" id="L39" title="All 2 branches covered.">        if (new Date().getTime() - bulkStartMillis &gt; minBulkAliveDurationMillis) {</span>
<span class="fc" id="L40">            this.flush(jobId);</span>
<span class="fc" id="L41">            bulkStartMillis = new Date().getTime();</span>
        }
<span class="fc" id="L43">        buffer.add(input);</span>
<span class="fc bfc" id="L44" title="All 2 branches covered.">        if (buffer.size() &gt;= CHUNK_SIZE)</span>
<span class="fc" id="L45">            this.performBulkInsert(jobId);</span>
<span class="fc" id="L46">    }</span>

    public void flush(ObjectId jobId) {
<span class="fc bfc" id="L49" title="All 2 branches covered.">        if (buffer.size() == 0)</span>
<span class="fc" id="L50">            return;</span>
<span class="fc" id="L51">        this.performBulkInsert(jobId);</span>
<span class="fc" id="L52">    }</span>

    private void performBulkInsert(ObjectId jobId) {
        try {
<span class="fc" id="L56">            BulkOperations bulkOps = this.outputMongoTemplate.bulkOps(BulkOperations.BulkMode.UNORDERED,</span>
                    entityClassType);
<span class="fc" id="L58">            synchronized (buffer) {</span>
<span class="fc" id="L59">                bulkOps.insert(buffer);</span>
<span class="fc" id="L60">                BulkWriteResult results = bulkOps.execute();</span>
<span class="fc" id="L61">                this.cc2JobRepository.incrementInsertedCount(jobId, results.getInsertedCount());</span>
<span class="fc" id="L62">            }</span>
<span class="fc" id="L63">        } catch (BulkOperationException e) {</span>
<span class="fc" id="L64">            logger.warn(&quot;BulkOperationException was thrown.&quot;);</span>
<span class="fc" id="L65">            logger.warn(&quot;If this is a reprocessing job, duplicates will be ignored.&quot;);</span>
<span class="fc" id="L66">            this.cc2JobRepository.incrementInsertedCount(jobId, e.getResult().getInsertedCount());</span>
<span class="fc" id="L67">            this.cc2JobRepository.incrementIgnoredDuplicateCount(jobId, e.getErrors().size());</span>
<span class="fc" id="L68">            Map&lt;Integer, Long&gt; errorCodeCounts = e.getErrors().stream()</span>
<span class="fc" id="L69">                .collect(Collectors.groupingBy(BulkWriteError::getCode, Collectors.counting()));</span>
<span class="fc" id="L70">            logger.warn(&quot;Distinct BulkOperationException codes count {code=count}: &quot;);</span>
<span class="fc" id="L71">            logger.warn(errorCodeCounts.toString());</span>
<span class="fc" id="L72">            logger.warn(&quot;Note: code 11000 is a duplicate key error.&quot;);</span>
        }finally{
<span class="fc" id="L74">            buffer = new ArrayList&lt;EntityClassType&gt;();</span>
        }
<span class="fc" id="L76">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>